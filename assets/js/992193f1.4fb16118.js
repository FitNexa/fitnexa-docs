"use strict";(globalThis.webpackChunkfitnexa_docs=globalThis.webpackChunkfitnexa_docs||[]).push([[769],{574(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"production-readiness/stability","title":"Stability Findings","description":"Critical and high-priority stability issues \u2014 graceful shutdown, token refresh, connection pooling, migrations","source":"@site/docs/production-readiness/stability.md","sourceDirName":"production-readiness","slug":"/production-readiness/stability","permalink":"/docs/production-readiness/stability","draft":false,"unlisted":false,"editUrl":"https://github.com/FitNexa/fitnexa-platform/tree/main/fitnexa-docs/docs/production-readiness/stability.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Stability Findings","description":"Critical and high-priority stability issues \u2014 graceful shutdown, token refresh, connection pooling, migrations"},"sidebar":"tutorialSidebar","previous":{"title":"Security Findings","permalink":"/docs/production-readiness/security"},"next":{"title":"Observability & Quality","permalink":"/docs/production-readiness/observability-quality"}}');var r=s(4848),t=s(8453);const o={sidebar_position:3,title:"Stability Findings",description:"Critical and high-priority stability issues \u2014 graceful shutdown, token refresh, connection pooling, migrations"},c="Stability Findings",d={},l=[{value:"\ud83d\udd34 C-3: No Graceful Shutdown (7/9 Services)",id:"-c-3-no-graceful-shutdown-79-services",level:2},{value:"\ud83d\udd34 C-4: Refresh Token Doesn&#39;t Verify User Status",id:"-c-4-refresh-token-doesnt-verify-user-status",level:2},{value:"\ud83d\udfe0 H-3: Bcrypt Rounds Inconsistent",id:"-h-3-bcrypt-rounds-inconsistent",level:2},{value:"\ud83d\udfe0 H-4: ApiClient Has No Request Timeout",id:"-h-4-apiclient-has-no-request-timeout",level:2},{value:"\ud83d\udfe0 H-5: ApiClient Has No Automatic Token Refresh",id:"-h-5-apiclient-has-no-automatic-token-refresh",level:2},{value:"\ud83d\udfe0 H-6: No Prisma Connection Pool Configuration",id:"-h-6-no-prisma-connection-pool-configuration",level:2},{value:"\ud83d\udfe1 M-1: No <code>uncaughtException</code> / <code>unhandledRejection</code> Handlers",id:"-m-1-no-uncaughtexception--unhandledrejection-handlers",level:2},{value:"\ud83d\udfe1 M-5: No Database Migration Strategy",id:"-m-5-no-database-migration-strategy",level:2},{value:"\ud83d\udfe1 M-6: No Retry Logic in ApiClient",id:"-m-6-no-retry-logic-in-apiclient",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"stability-findings",children:"Stability Findings"})}),"\n",(0,r.jsx)(n.h2,{id:"-c-3-no-graceful-shutdown-79-services",children:"\ud83d\udd34 C-3: No Graceful Shutdown (7/9 Services)"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Every service except ",(0,r.jsx)(n.code,{children:"messaging-service"})]}),"\n",(0,r.jsxs)(n.p,{children:["Only messaging-service handles ",(0,r.jsx)(n.code,{children:"SIGTERM"}),". When Docker/PM2 sends SIGTERM, services die immediately \u2014 dropping in-flight requests, leaving Prisma connections open, and potentially corrupting transactions."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," Data corruption on deploy, connection pool exhaustion, lost requests during rolling deployments."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add to ",(0,r.jsx)(n.code,{children:"createBaseService()"})," in ",(0,r.jsx)(n.code,{children:"bootstrap.ts"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const shutdown = async () => {\n    logger.info('Graceful shutdown initiated...');\n    server.close(async () => {\n        await prisma?.$disconnect();\n        process.exit(0);\n    });\n    setTimeout(() => process.exit(1), 10_000); // Force kill after 10s\n};\nprocess.on('SIGTERM', shutdown);\nprocess.on('SIGINT', shutdown);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-c-4-refresh-token-doesnt-verify-user-status",children:"\ud83d\udd34 C-4: Refresh Token Doesn't Verify User Status"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"AuthService.refresh()"})]}),"\n",(0,r.jsxs)(n.p,{children:["The refresh flow verifies the JWT signature and issues a new access token but ",(0,r.jsx)(n.strong,{children:"never checks"})," if the user still exists, is still ",(0,r.jsx)(n.code,{children:"ACTIVE"}),", or has been banned."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"async refresh(token: string) {\n    const payload = AuthUtils.verifyRefreshToken(token);\n    // \u2190 No database lookup! No status check!\n    const newAccessToken = AuthUtils.generateAccessToken(payload);\n    return { accessToken: newAccessToken };\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," Banned/deleted/deactivated users keep getting valid tokens for up to 7 days."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"async refresh(token: string) {\n    const payload = AuthUtils.verifyRefreshToken(token);\n    const user = await this.userRepository.findById(payload.userId);\n    if (!user || user.status !== 'ACTIVE') {\n        throw new UnauthorizedError('Account suspended');\n    }\n    return {\n        accessToken: AuthUtils.generateAccessToken({\n            ...payload, role: user.role\n        })\n    };\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-h-3-bcrypt-rounds-inconsistent",children:"\ud83d\udfe0 H-3: Bcrypt Rounds Inconsistent"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"AuthService"})]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Operation"}),(0,r.jsx)(n.th,{children:"Rounds"}),(0,r.jsx)(n.th,{children:"Location"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"register()"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"10"})}),(0,r.jsx)(n.td,{children:"AuthService.ts:103"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"createGymAdmin()"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"10"})}),(0,r.jsx)(n.td,{children:"AuthService.ts:175"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"activateUser()"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"12"})}),(0,r.jsx)(n.td,{children:"AuthService.ts:208"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:"OWASP recommends \u2265 12 rounds."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Define a constant ",(0,r.jsx)(n.code,{children:"const BCRYPT_ROUNDS = 12;"})," and use everywhere."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-h-4-apiclient-has-no-request-timeout",children:"\ud83d\udfe0 H-4: ApiClient Has No Request Timeout"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"apiClient.ts"})]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"fetch()"})," call has no ",(0,r.jsx)(n.code,{children:"AbortController"})," timeout. If the gateway hangs, clients wait ",(0,r.jsx)(n.strong,{children:"forever"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const controller = new AbortController();\nconst timeoutId = setTimeout(() => controller.abort(), 15_000);\nconst response = await fetch(url, { ...finalInit, signal: controller.signal });\nclearTimeout(timeoutId);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-h-5-apiclient-has-no-automatic-token-refresh",children:"\ud83d\udfe0 H-5: ApiClient Has No Automatic Token Refresh"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"apiClient.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"When a 401 is returned (token expired), the client just throws. Admin web apps likely don't handle this \u2014 users get logged out every 15 minutes."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add interceptor logic:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"if (response.status === 401 && config.onUnauthorized) {\n    const retried = await config.onUnauthorized();\n    if (retried) return request(options); // Retry with new token\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-h-6-no-prisma-connection-pool-configuration",children:"\ud83d\udfe0 H-6: No Prisma Connection Pool Configuration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," All services \u2014 ",(0,r.jsx)(n.code,{children:"new PrismaClient()"})," with defaults"]}),"\n",(0,r.jsxs)(n.p,{children:["Default pool is ",(0,r.jsx)(n.code,{children:"num_cpus * 2 + 1"}),". Under load, PostgreSQL rejects excess connections."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," ",(0,r.jsx)(n.code,{children:"P2024: Connection pool timeout"})," under moderate load."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Configure via DATABASE_URL:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"postgresql://user:pass@host:5432/db?connection_limit=5&pool_timeout=10\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"-m-1-no-uncaughtexception--unhandledrejection-handlers",children:["\ud83d\udfe1 M-1: No ",(0,r.jsx)(n.code,{children:"uncaughtException"})," / ",(0,r.jsx)(n.code,{children:"unhandledRejection"})," Handlers"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Only ",(0,r.jsx)(n.code,{children:"nutrition-service"})," has these. Other services have none."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," Unhandled promise rejections crash Node silently. No logs, no alerts."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add to ",(0,r.jsx)(n.code,{children:"createBaseService()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"process.on('uncaughtException', (error) => {\n    logger.error('UNCAUGHT EXCEPTION', { error: error.message, stack: error.stack });\n    process.exit(1);\n});\nprocess.on('unhandledRejection', (reason) => {\n    logger.error('UNHANDLED REJECTION', { reason });\n});\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-5-no-database-migration-strategy",children:"\ud83d\udfe1 M-5: No Database Migration Strategy"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," All services use ",(0,r.jsx)(n.code,{children:"prisma db push"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"prisma db push"})," is for prototyping. It doesn't create migration files, can't be rolled back, and will ",(0,r.jsx)(n.strong,{children:"drop data"})," if you rename a column."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Switch to ",(0,r.jsx)(n.code,{children:"prisma migrate dev"})," for creating migrations"]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.code,{children:"prisma migrate deploy"})," in CI/CD"]}),"\n",(0,r.jsxs)(n.li,{children:["Never use ",(0,r.jsx)(n.code,{children:"prisma db push"})," in production"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-6-no-retry-logic-in-apiclient",children:"\ud83d\udfe1 M-6: No Retry Logic in ApiClient"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"apiClient.ts"})]}),"\n",(0,r.jsx)(n.p,{children:"Transient network errors (timeout, DNS) fail immediately with no retry."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add exponential backoff for 5xx and network errors:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const MAX_RETRIES = 2;\nfor (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {\n    try { return await doRequest(); }\n    catch (e) {\n        if (attempt === MAX_RETRIES || !isRetryable(e)) throw e;\n        await delay(Math.pow(2, attempt) * 500);\n    }\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["Related: ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/security",children:"Security Findings"})," \xb7 ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/observability-quality",children:"Observability & Quality"})," \xb7 ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/roadmap",children:"Fix Roadmap"})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>c});var i=s(6540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);