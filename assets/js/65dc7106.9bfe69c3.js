"use strict";(globalThis.webpackChunkfitnexa_docs=globalThis.webpackChunkfitnexa_docs||[]).push([[6877],{2331(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"production-readiness/observability-quality","title":"Observability & Quality","description":"Medium and low-priority findings \u2014 logging, health checks, validation, code quality, and enhancements","source":"@site/docs/production-readiness/observability-quality.md","sourceDirName":"production-readiness","slug":"/production-readiness/observability-quality","permalink":"/docs/production-readiness/observability-quality","draft":false,"unlisted":false,"editUrl":"https://github.com/FitNexa/fitnexa-platform/tree/main/fitnexa-docs/docs/production-readiness/observability-quality.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Observability & Quality","description":"Medium and low-priority findings \u2014 logging, health checks, validation, code quality, and enhancements"},"sidebar":"tutorialSidebar","previous":{"title":"Stability Findings","permalink":"/docs/production-readiness/stability"},"next":{"title":"Fix Roadmap","permalink":"/docs/production-readiness/roadmap"}}');var r=s(4848),t=s(8453);const d={sidebar_position:4,title:"Observability & Quality",description:"Medium and low-priority findings \u2014 logging, health checks, validation, code quality, and enhancements"},l="Observability & Code Quality Findings",o={},a=[{value:"\ud83d\udfe0 H-2: No Input Validation on Most Endpoints",id:"-h-2-no-input-validation-on-most-endpoints",level:2},{value:"\ud83d\udfe1 M-2: No Health Check Consistency",id:"-m-2-no-health-check-consistency",level:2},{value:"\ud83d\udfe1 M-3: Logging Inconsistency",id:"-m-3-logging-inconsistency",level:2},{value:"\ud83d\udfe1 M-4: No Request Logging at Gateway Level",id:"-m-4-no-request-logging-at-gateway-level",level:2},{value:"\ud83d\udfe1 M-7: JWT Payload Contains Stale Data",id:"-m-7-jwt-payload-contains-stale-data",level:2},{value:"\ud83d\udd35 Low Priority",id:"-low-priority",level:2},{value:"L-1: No Correlation ID Propagation Across Services",id:"l-1-no-correlation-id-propagation-across-services",level:3},{value:"L-2: PrismaClient Created at Module Level",id:"l-2-prismaclient-created-at-module-level",level:3},{value:"L-3: Seed Data Runs on Every Start",id:"l-3-seed-data-runs-on-every-start",level:3},{value:"L-4: <code>any</code> Types in Shared Library",id:"l-4-any-types-in-shared-library",level:3},{value:"\u26aa Enhancements",id:"-enhancements",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"observability--code-quality-findings",children:"Observability & Code Quality Findings"})}),"\n",(0,r.jsx)(n.h2,{id:"-h-2-no-input-validation-on-most-endpoints",children:"\ud83d\udfe0 H-2: No Input Validation on Most Endpoints"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Zod schemas exist only in ",(0,r.jsx)(n.strong,{children:"3/9 services"})," (gym, identity, wizard)"]}),"\n",(0,r.jsxs)(n.p,{children:["Services with ",(0,r.jsx)(n.strong,{children:"zero input validation"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"content-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"nutrition-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"squad-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"messaging-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"logging-service"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"gateway"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," Unexpected payloads crash services, invalid data stored in DB."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Create Zod schemas for every endpoint. Use a shared ",(0,r.jsx)(n.code,{children:"validate()"})," middleware:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"// @fitnexa/shared/middleware\nexport const validate = (schema: ZodSchema) => (req, res, next) => {\n    const result = schema.safeParse(req.body);\n    if (!result.success) {\n        throw new ValidationError('Invalid input', result.error.flatten());\n    }\n    req.body = result.data; // Type-safe, sanitized\n    next();\n};\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-2-no-health-check-consistency",children:"\ud83d\udfe1 M-2: No Health Check Consistency"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Services have different health patterns:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Pattern"}),(0,r.jsx)(n.th,{children:"Services"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["Generic ",(0,r.jsx)(n.code,{children:"/health"})," (no DB check)"]}),(0,r.jsx)(n.td,{children:"identity, nutrition, content, squad, wizard, logging, messaging"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"/health"})," + ",(0,r.jsx)(n.code,{children:"/ready"})," (checks DB)"]}),(0,r.jsx)(n.td,{children:"gym"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["Custom ",(0,r.jsx)(n.code,{children:"/health"})," format"]}),(0,r.jsx)(n.td,{children:"gateway"})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Risk:"})," ",(0,r.jsx)(n.code,{children:"/health"}),' says "healthy" even when the database is down.']}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add ",(0,r.jsx)(n.code,{children:"/ready"})," to ",(0,r.jsx)(n.code,{children:"createBaseService()"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"app.get('/ready', async (req, res) => {\n    try {\n        await prisma?.$queryRaw`SELECT 1`;\n        res.json({ status: 'READY' });\n    } catch {\n        res.status(503).json({ status: 'NOT_READY' });\n    }\n});\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/health"})," = liveness (process running)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"/ready"})," = readiness (DB connected, dependencies available)"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-3-logging-inconsistency",children:"\ud83d\udfe1 M-3: Logging Inconsistency"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Across all services"]}),"\n",(0,r.jsxs)(n.p,{children:["Some services use ",(0,r.jsx)(n.code,{children:"createLogger()"})," (Winston), others use ",(0,r.jsx)(n.code,{children:"console.log"}),". Error objects are sometimes ",(0,r.jsx)(n.code,{children:"{ error: e }"})," and sometimes ",(0,r.jsx)(n.code,{children:"{ error: e.message }"})," \u2014 losing stack traces."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Fix:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Ban ",(0,r.jsx)(n.code,{children:"console.log/error/warn"})," via ESLint rule"]}),"\n",(0,r.jsxs)(n.li,{children:["Always log errors with full context: ",(0,r.jsx)(n.code,{children:"logger.error('msg', { error: err.message, stack: err.stack })"})]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-4-no-request-logging-at-gateway-level",children:"\ud83d\udfe1 M-4: No Request Logging at Gateway Level"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," Gateway"]}),"\n",(0,r.jsx)(n.p,{children:"The gateway proxies requests but doesn't log client IP, endpoint, status code, or duration. No audit trail."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Add logging middleware BEFORE proxy routes:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"app.use((req, res, next) => {\n    const start = Date.now();\n    res.on('finish', () => {\n        logger.info('request', {\n            method: req.method, path: req.path,\n            status: res.statusCode, duration: Date.now() - start,\n            ip: req.ip, correlationId: req.headers['x-correlation-id']\n        });\n    });\n    next();\n});\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-m-7-jwt-payload-contains-stale-data",children:"\ud83d\udfe1 M-7: JWT Payload Contains Stale Data"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Where:"})," ",(0,r.jsx)(n.code,{children:"AuthUtils"})]}),"\n",(0,r.jsxs)(n.p,{children:["JWT contains ",(0,r.jsx)(n.code,{children:"role"})," and ",(0,r.jsx)(n.code,{children:"gymId"}),". If an admin changes a user's role, old values persist for up to 15 minutes (access) or 7 days (refresh token)."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Acceptable for 15-min access tokens if refresh checks DB (see C-4). Long-term: store only ",(0,r.jsx)(n.code,{children:"userId"})," in JWT and fetch role/gym from Redis cache on each request."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-low-priority",children:"\ud83d\udd35 Low Priority"}),"\n",(0,r.jsx)(n.h3,{id:"l-1-no-correlation-id-propagation-across-services",children:"L-1: No Correlation ID Propagation Across Services"}),"\n",(0,r.jsxs)(n.p,{children:["The gateway doesn't forward ",(0,r.jsx)(n.code,{children:"X-Correlation-Id"})," to downstream services. Each service generates its own, making cross-service tracing impossible."]}),"\n",(0,r.jsx)(n.h3,{id:"l-2-prismaclient-created-at-module-level",children:"L-2: PrismaClient Created at Module Level"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"const prisma = new PrismaClient()"})," at top-level makes DI harder and prevents per-environment config."]}),"\n",(0,r.jsx)(n.h3,{id:"l-3-seed-data-runs-on-every-start",children:"L-3: Seed Data Runs on Every Start"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"identity-service"})," and ",(0,r.jsx)(n.code,{children:"gym-service"})," seed on every startup. In production, this could overwrite real data."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Fix:"})," Guard with ",(0,r.jsx)(n.code,{children:"if (process.env.NODE_ENV === 'development') await seed();"})]}),"\n",(0,r.jsxs)(n.h3,{id:"l-4-any-types-in-shared-library",children:["L-4: ",(0,r.jsx)(n.code,{children:"any"})," Types in Shared Library"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"bootstrap.ts:77"})," \u2014 ",(0,r.jsx)(n.code,{children:"logger: any"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"apiClient.ts:67"})," \u2014 ",(0,r.jsx)(n.code,{children:"Promise<any>"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"errors/index.ts:6"})," \u2014 ",(0,r.jsx)(n.code,{children:"details?: any"})]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"-enhancements",children:"\u26aa Enhancements"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"ID"}),(0,r.jsx)(n.th,{children:"Enhancement"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"E-1"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"API Versioning"})}),(0,r.jsxs)(n.td,{children:["No versioning exists. Prefix routes with ",(0,r.jsx)(n.code,{children:"/v1/"}),"."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"E-2"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Structured DTOs"})}),(0,r.jsx)(n.td,{children:"Controllers pass raw bodies to services \u2014 use explicit request/response types."})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"E-3"}),(0,r.jsx)(n.td,{children:(0,r.jsxs)(n.strong,{children:["DB Health in ",(0,r.jsx)(n.code,{children:"/health"})]})}),(0,r.jsxs)(n.td,{children:["Generic ",(0,r.jsx)(n.code,{children:"/health"})," doesn't check database. See M-2."]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"E-4"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"OpenTelemetry"})}),(0,r.jsx)(n.td,{children:"No distributed tracing. 9 services need tracing for cross-boundary debugging."})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["Related: ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/security",children:"Security Findings"})," \xb7 ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/stability",children:"Stability Findings"})," \xb7 ",(0,r.jsx)(n.a,{href:"/docs/production-readiness/roadmap",children:"Fix Roadmap"})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453(e,n,s){s.d(n,{R:()=>d,x:()=>l});var i=s(6540);const r={},t=i.createContext(r);function d(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);